{% extends "base.html" %}

{% block title %}Scan Network - Advanced Network Scanner{% endblock %}

{% block header %}üîç Network Scan Configuration{% endblock %}

{% block subtitle %}Configure and start your network security scan{% endblock %}

{% block content %}
<div class="card">
    <h2>Select Scan Type</h2>
    <div class="scan-types">
        <div class="scan-type" onclick="selectScanType('full')" id="full-type">
            <div class="scan-type-icon">üõ°Ô∏è</div>
            <h3>Full Network Scan</h3>
            <p>Complete vulnerability assessment of all devices</p>
        </div>
        <div class="scan-type" onclick="selectScanType('cameras')" id="cameras-type">
            <div class="scan-type-icon">üìπ</div>
            <h3>Camera Detection</h3>
            <p>Find IP cameras, DVRs, and NVR systems</p>
        </div>
        <div class="scan-type" onclick="selectScanType('ports')" id="ports-type">
            <div class="scan-type-icon">üîì</div>
            <h3>Port Scan</h3>
            <p>Scan specific ports on network devices</p>
        </div>
    </div>
    
    <form id="scanForm">
        <div class="form-group">
            <label for="network">Network CIDR:</label>
            <input type="text" id="network" name="network" value="192.168.1.0/24" placeholder="e.g., 192.168.1.0/24">
        </div>
        
        <input type="hidden" id="scanType" name="scanType" value="full">
        
        <button type="submit">Start Scan</button>
    </form>
</div>

<div class="card">
    <div class="tabs">
        <button class="tab active" onclick="switchTab('basic')">Basic Scan</button>
        <button class="tab" onclick="switchTab('advanced')">Advanced Options</button>
        <button class="tab" onclick="switchTab('schedule')">Schedule</button>
    </div>
    
    <div id="basic" class="tab-content active">
        <p>Select a scan type above and enter your network range to begin.</p>
    </div>
    
    <div id="advanced" class="tab-content">
        <div class="advanced-options">
            <div class="form-group">
                <label for="ports">Custom Ports (comma-separated):</label>
                <input type="text" id="ports" name="ports" placeholder="e.g., 22,80,443,3389">
            </div>
            
            <div class="form-group">
                <label for="excludeIps">Exclude IPs (comma-separated):</label>
                <input type="text" id="excludeIps" name="excludeIps" placeholder="e.g., 192.168.1.1,192.168.1.254">
            </div>
            
            <div class="form-group">
                <label for="scanProfile">Scan Profile:</label>
                <select id="scanProfile" name="scanProfile">
                    <option value="quick">Quick Scan</option>
                    <option value="standard" selected>Standard Scan</option>
                    <option value="comprehensive">Comprehensive Scan</option>
                    <option value="stealth">Stealth Scan</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="saveResults" name="saveResults" checked> 
                    Save results to persistent storage
                </label>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" id="generateReport" name="generateReport" checked> 
                    Generate detailed report
                </label>
            </div>
        </div>
    </div>
    
    <div id="schedule" class="tab-content">
        <div class="advanced-options">
            <p>Scheduled scans coming in future versions.</p>
            <p>For now, you can use system cron jobs or task scheduler to run scans automatically.</p>
        </div>
    </div>
</div>

<div class="status" id="statusDiv">
    <h3>Scan Status</h3>
    <p id="statusText">Starting scan...</p>
    <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Select scan type
    function selectScanType(type) {
        // Remove selected class from all
        document.querySelectorAll('.scan-type').forEach(el => {
            el.classList.remove('selected');
        });
        
        // Add selected class to clicked element
        document.getElementById(type + '-type').classList.add('selected');
        
        // Set hidden input value
        document.getElementById('scanType').value = type;
    }
    
    // Switch tabs
    function switchTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        
        // Remove active class from all tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show selected tab content
        document.getElementById(tabName).classList.add('active');
        
        // Add active class to clicked tab
        event.target.classList.add('active');
    }
    
    // Form submission
    document.getElementById('scanForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const network = document.getElementById('network').value;
        const scanType = document.getElementById('scanType').value;
        
        // Show status
        document.getElementById('statusDiv').style.display = 'block';
        document.getElementById('statusText').textContent = 'Starting scan on ' + network + '...';
        
        // Send scan request
        fetch('/api/scan_network', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                network: network,
                scan_type: scanType
            })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('statusText').textContent = 'Scan started: ' + data.network;
            
            // Poll for status updates
            const statusInterval = setInterval(() => {
                fetch('/api/status')
                .then(response => response.json())
                .then(status => {
                    document.getElementById('progressBar').style.width = status.progress + '%';
                    document.getElementById('statusText').textContent = 'Status: ' + status.status + ' (' + status.progress + '%)';
                    
                    if (status.status === 'completed' || status.status === 'error') {
                        clearInterval(statusInterval);
                        if (status.status === 'completed') {
                            document.getElementById('statusText').textContent = 'Scan completed!';
                            // Redirect based on scan type
                            setTimeout(() => {
                                if (scanType === 'cameras') {
                                    window.location.href = '/cameras';
                                } else {
                                    window.location.href = '/results';
                                }
                            }, 3000);
                        } else {
                            document.getElementById('statusText').textContent = 'Scan failed!';
                        }
                    }
                });
            }, 1000);
        })
        .catch(error => {
            document.getElementById('statusText').textContent = 'Error: ' + error;
        });
    });
</script>
{% endblock %}