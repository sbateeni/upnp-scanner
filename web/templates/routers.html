{% extends "base.html" %}

{% block title %}Router Discovery - Advanced Network Scanner{% endblock %}

{% block header %}üì∂ Router Discovery{% endblock %}

{% block subtitle %}Discover surrounding WiFi networks and routers{% endblock %}

{% block content %}
<div class="card">
    <h2>üîç WiFi Network Discovery</h2>
    <div class="network-info">
        <p>This feature detects surrounding WiFi networks and routers in your vicinity. 
        It will show available networks, signal strength, and security information.</p>
    </div>
    
    <div class="adapter-selection" id="adapterSelection">
        <h3>üì° WiFi Adapter Selection</h3>
        <div class="form-group">
            <label for="wifiAdapter">Select WiFi Adapter:</label>
            <select id="wifiAdapter" class="wifi-adapter-select">
                <option value="">Loading adapters...</option>
            </select>
        </div>
        <button class="action-btn" onclick="refreshAdapters()">üîÑ Refresh Adapters</button>
    </div>
    
    <button class="scan-btn" onclick="discoverRouters()">üì° Discover Routers</button>
</div>

<div class="card">
    <h2>üì° Detected Networks</h2>
    <div class="detected-networks" id="routersContainer">
        <p>Click "Discover Routers" to scan for surrounding WiFi networks.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load adapters when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadWifiAdapters();
    });
    
    function loadWifiAdapters() {
        const adapterSelect = document.getElementById('wifiAdapter');
        adapterSelect.innerHTML = '<option value="">Loading adapters...</option>';
        
        fetch('/api/list_wifi_adapters')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayAdapters(data.adapters);
            } else {
                adapterSelect.innerHTML = '<option value="">Error loading adapters</option>';
                console.error('Error loading adapters:', data.message);
            }
        })
        .catch(error => {
            adapterSelect.innerHTML = '<option value="">Error loading adapters</option>';
            console.error('Error loading adapters:', error);
        });
    }
    
    function refreshAdapters() {
        loadWifiAdapters();
    }
    
    function displayAdapters(adapters) {
        const adapterSelect = document.getElementById('wifiAdapter');
        
        if (adapters.length === 0) {
            adapterSelect.innerHTML = '<option value="">No adapters found</option>';
            return;
        }
        
        let html = '<option value="">Select an adapter (default: automatic)</option>';
        adapters.forEach(adapter => {
            const name = adapter.name || 'Unknown';
            const description = adapter.description || 'No description';
            html += `<option value="${name}">${name} - ${description}</option>`;
        });
        
        adapterSelect.innerHTML = html;
    }
    
    function discoverRouters() {
        // Show loading
        const container = document.getElementById('routersContainer');
        const selectedAdapter = document.getElementById('wifiAdapter').value;
        
        if (selectedAdapter) {
            container.innerHTML = `<p>üì° Scanning for WiFi networks on adapter "${selectedAdapter}"... Please wait.</p>`;
            
            // Discover routers on specific adapter
            fetch('/api/discover_routers_on_adapter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    adapter_name: selectedAdapter
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayRouters(data.routers);
                } else {
                    container.innerHTML = '<p>‚ùå Error: ' + data.message + '</p>';
                }
            })
            .catch(error => {
                container.innerHTML = '<p>‚ùå Error discovering routers: ' + error + '</p>';
            });
        } else {
            container.innerHTML = '<p>üì° Scanning for WiFi networks... Please wait.</p>';
            
            // Discover routers on default adapter
            fetch('/api/discover_routers')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayRouters(data.routers);
                } else {
                    container.innerHTML = '<p>‚ùå Error: ' + data.message + '</p>';
                }
            })
            .catch(error => {
                container.innerHTML = '<p>‚ùå Error discovering routers: ' + error + '</p>';
            });
        }
    }
    
    function displayRouters(routers) {
        const container = document.getElementById('routersContainer');
        
        if (routers.length === 0) {
            container.innerHTML = '<p>No WiFi networks detected.</p>';
            return;
        }
        
        let html = `<p>Found ${routers.length} WiFi networks:</p>`;
        
        routers.forEach((router, index) => {
            html += `
            <div class="network-item">
                <h3>Network ${index + 1}: ${router.ssid || 'Hidden Network'}</h3>
                <div class="network-details">
                    <p><strong>BSSID:</strong> ${router.bssid || 'Unknown'}</p>
                    <p><strong>Signal:</strong> ${router.signal || 'Unknown'} ${router.signal_percentage ? '(' + router.signal_percentage + ')' : ''}</p>
                    <p><strong>Security:</strong> ${router.security || 'Unknown'}</p>
                </div>
            </div>
            `;
        });
        
        container.innerHTML = html;
    }
</script>
{% endblock %}